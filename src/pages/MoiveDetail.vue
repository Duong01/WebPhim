<template>
  <v-container class="search-page" fluid>
    <v-col cols="12" class="text-center" v-if="isLoading">
      <v-progress-circular indeterminate color="primary" size="50" />
    </v-col>
    <div v-else-if="isLoadingData">
      <p style="text-align: center;">{{$t('H·∫øt th·ªùi gian y√™u c·∫ßu, vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng truy·ªÅn internet')}}</p>
    </div>
    <div v-else>
      <!-- Breadcrumb -->
      <v-breadcrumbs :items="items">
        <template v-slot:divider>
          <v-icon icon="mdi-chevron-right"></v-icon>
        </template>
      </v-breadcrumbs>

      <!-- B·ªë c·ª•c hai c·ªôt -->
      <v-row dense>
        <!-- C·ªôt b√™n tr√°i: Video + n√∫t + danh s√°ch t·∫≠p + info -->
        <v-col cols="12" md="10">
          <!-- VIDEO -->
          <!-- v-html="generateEmbedHtml(movie.videoUrl)" -->
          <div
            class="video-wrapper"
          >
          <video
            ref="videoPlayer"
            controls
            autoplay
            preload="metadata"
            style="width: 100%; height: 100%; background-color: black;"
          ></video>
    </div>

          <!-- nut next tap v√† back tap -->
           <div class="d-flex justify-center align-center my-3" style="gap: 12px">
              <v-btn
                color="grey-darken-2"
                @click="prevEpisode"
                :disabled="currentEpisodeIndex <= 0"
              >
                <v-icon start>mdi-chevron-left</v-icon>
                {{ $t("T·∫≠p tr∆∞·ªõc") }}
              </v-btn>

              <v-chip color="blue-darken-2" text-color="white">
                {{ $t("T·∫≠p") }} {{ currentEpisodeIndex +1}}
              </v-chip>

              <v-btn
                color="grey-darken-2"
                @click="nextEpisode"
                :disabled="currentEpisodeIndex >= movie.pageMovie.length - 1"
              >
                {{ $t("T·∫≠p ti·∫øp") }}
                <v-icon end>mdi-chevron-right</v-icon>
              </v-btn>
            </div>

          <!-- Nh√≥m n√∫t + server -->
          <div
            class="d-flex align-center justify-space-between flex-wrap px-4 py-2"
            style="background-color: #1a1a1a"
          >
            <!-- N√∫t ch·ª©c nƒÉng -->
            <div class="d-flex align-center flex-wrap" style="gap: 16px">
              <v-btn variant="text" @click="getTrailer()">
                <v-icon start icon="mdi-youtube" />
                Trailer
              </v-btn>
              <v-btn variant="text" @click="shareMovie"
                ><v-icon start icon="mdi-share-variant" />{{
                  $t("Chia s·∫ª")
                }}</v-btn
              >
              <v-btn variant="text" @click="ResponseError"
                ><v-icon start icon="mdi-flag" />{{ $t("B√°o l·ªói") }}</v-btn
              >
              <v-btn variant="text" @click="handleFavorite"
                ><v-icon start :icon="isFavorited ? 'mdi-bookmark' : 'mdi-bookmark-outline'" />{{
                  $t("Xem sau")
                }}</v-btn
              >
            </div>

            <!-- Server -->

            <div
              class="d-flex align-center"
              style="gap: 8px; overflow-x: auto; flex-wrap: nowrap"
            >
              <router-link :to="movie.LinkDown" download target="_blank">
                <v-btn class="ma-2" icon="mdi-cloud-download"></v-btn>
              </router-link>
              <v-tabs
                v-model="tabserver"
                class="custom-tabs flex-shrink-0"
                background-color="transparent"
              >
                <v-tab
                  v-for="(server, index) in movie.servers"
                  :key="index"
                  @click="switchServer(server)"
                  :class="{ 'active-tab': tabserver === index }"
                >
                  {{ server.server_name || `Server ${index + 1}` }}
                </v-tab>
              </v-tabs>
            </div>
          </div>

          <!-- Danh s√°ch t·∫≠p -->
          <v-card
            class="my-4"
            variant="flat"
            color="grey-darken-4"
            theme="dark"
          >
            <v-card-title class="d-flex align-center">
              <span class="text-h6">{{ movie.title }}</span>
              <v-chip class="ml-2" color="red" text-color="white">{{
                movie.page
              }}</v-chip>
              <v-chip
                class="ml-2"
                color="red"
                text-color="white"
                v-if="
                  typeof movie.page === 'string' &&
                  movie.page.toUpperCase().includes('HO√ÄN T·∫§T')
                "
              >
                {{ $t("T·∫≠p ") }}1
              </v-chip>
            </v-card-title>
            <v-card-text>
              <v-row class="episode-list">
                <v-col
                  v-for="(episode, index) in movie.pageMovie"
                  :key="index"
                  class="episode-col"
                >
                  <v-btn color="primary" block size="small" @click="playEpisode(episode)">
                    {{
                      episode.name
                        ? episode.name.includes("T·∫≠p")
                          ? episode.name
                          : $t("T·∫≠p ") + episode.name
                        : "Trailer"
                    }}
                  </v-btn>
                </v-col>
              </v-row>
            </v-card-text>
          </v-card>

          <!-- TRAILER -->
          <div class="mb-4">
            <v-row>
              <v-col cols="12" sm="6" md="3">
                <h3 class="text-white mb-2">TRAILER</h3>

                <!-- Thumb container -->
                <div
                  class="trailer-thumb"
                  @click="dialogTrailer = true"
                  role="button"
                  aria-label="Play trailer"
                >
                  <img
                    :src="`https://img.youtube.com/vi/${movie.trailer_id}/mqdefault.jpg`"
                    :alt="`Trailer ${movie.name}`"
                    loading="lazy"
                  />

                  <!-- dark overlay khi hover -->
                  <div class="trailer-overlay" />

                  <!-- n√∫t Play (SVG) ·ªü gi·ªØa -->
                  <div class="trailer-play" aria-hidden="true">
                    <svg
                      width="64"
                      height="64"
                      viewBox="0 0 64 64"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <!-- n·ªÅn tr√≤n t·ªëi ƒë·ªÉ l√†m n·ªïi tam gi√°c -->
                      <circle cx="32" cy="32" r="30" fill="rgba(0,0,0,0.55)" />
                      <!-- tam gi√°c play m√†u tr·∫Øng -->
                      <path d="M26 20 L46 32 L26 44 Z" fill="#fff" />
                    </svg>
                  </div>
                </div>
              </v-col>

              <v-col cols="12" sm="6" md="6" class="d-flex align-center">
                <p class="text-grey-lighten-1">
                  {{ movie.title }} - {{ $t("Xem trailer ch√≠nh th·ª©c") }}
                </p>
              </v-col>
            </v-row>
          </div>

          <!-- Dialog trailer -->
          <v-dialog v-model="dialogTrailer" max-width="900px" persistent>
            <v-card class="bg-black relative">
              <!-- N√∫t ƒë√≥ng -->
              <v-btn
                icon="mdi-close"
                class="absolute top-2 right-2 z-10"
                variant="text"
                @click="dialogTrailer = false"
              ></v-btn>

              <!-- Video -->
              <iframe
                width="100%"
                height="600"
                :src="`https://www.youtube.com/embed/${movie.trailer_id}?autoplay=1`"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                loading="lazy"
              >
              </iframe>

              <!-- <iframe
      width="100%"
      height="500"
      :src="movie.trailer_url"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
    ></iframe> -->
            </v-card>
          </v-dialog>

          <!-- Th√¥ng tin phim -->
          <v-card
            class="pa-6 text-left"
            color="grey-darken-4"
            variant="flat"
            rounded="lg"
            theme="dark"
          >
            <v-card-title class="text-white mb-4"
              >{{ movie.title }} ( {{ movie.name }})</v-card-title
            >
            <v-card-text class="text-white">
              <div v-html="movie.description"></div>
            </v-card-text>
            <v-card-text class="text-white">
              <p>
                <strong>{{ $t("Di·ªÖn vi√™n") }}:</strong>
                {{ movie.actors.join(", ") }}
              </p>
              <p>
                <strong>{{ $t("ƒê·∫°o di·ªÖn") }}:</strong>
                {{ movie.director.join(", ") }}
              </p>
              <p>
                <strong>{{ $t("Th·ªÉ lo·∫°i") }}:</strong> {{ movie.genre.name }}
              </p>
              <div class="d-flex align-center">
                <strong class="mr-2">{{ $t("ƒê√°nh gi√°") }}:</strong>
                <v-rating
                  readonly
                  :length="5"
                  :size="28"
                  :model-value="movie.rating"
                  active-color="yellow-darken-2"
                />
              </div>
            </v-card-text>
          </v-card>

          <!-- B√¨nh lu·∫≠n -->
          <v-card flat color="#1e1e1e" class="pa-6 rounded-xl elevation-2 mt-6">
            <h2 class="text-white mb-6 text-h5 font-weight-bold">
              üó®Ô∏è {{ $t("B√¨nh lu·∫≠n") }}
            </h2>
            <v-text-field
              v-model="newComment"
              :placeholder="$t('Th√™m b√¨nh lu·∫≠n...')"
              variant="outlined"
              color="blue"
              class="rounded-xl mb-4"
              density="comfortable"
              hide-details
              append-inner-icon="mdi-send"
              @click:append-inner="addComment"
              :rules="[(v) => !!v || $t('B√¨nh lu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng')]"
            ></v-text-field>
            <v-divider class="mb-4" color="grey darken-3"></v-divider>
            <div
              v-for="(comment, index) in comments"
              :key="index"
              class="d-flex align-start mb-5"
            >
              <v-avatar size="44" class="me-3" color="blue-grey-darken-3">
                <v-icon color="white">mdi-account</v-icon>
              </v-avatar>
              <div class="flex-grow-1">
                <div class="d-flex align-center mb-1">
                  <span class="text-blue-lighten-3 font-weight-medium me-2">{{
                    comment.username
                  }}</span>
                  <v-chip
                    size="x-small"
                    color="grey-darken-4"
                    text-color="grey-lighten-1"
                    variant="flat"
                  >
                    {{ comment.time }}
                  </v-chip>
                </div>
                <div class="text-white text-body-2">{{ comment.content }}</div>
                <div
                  class="text-caption mt-2 text-grey-lighten-1"
                  style="cursor: pointer"
                >
                  {{ $t("Ph·∫£n h·ªìi") }}
                </div>
              </div>
            </div>
          </v-card>
        </v-col>

        <!-- C·ªôt b√™n ph·∫£i: G·ª£i √Ω -->
        <!-- C·ªôt b√™n ph·∫£i: G·ª£i √Ω ch·ªâ hi·ªán tr√™n desktop -->
        <v-col cols="12" md="2" v-show="$vuetify.display.mdAndUp">
          <v-card class="pa-0" color="grey-darken-4" flat>
            <v-tabs v-model="tab" background-color="grey-darken-3" grow>
              <v-tab value="1">{{ $t("G·ª£i √Ω cho b·∫°n") }}</v-tab>
              <v-tab value="2">{{ $t("Top phim") }}</v-tab>
            </v-tabs>

            <v-card-text style="max-height: 87vh; overflow-y: auto">
              <v-list dense nav>
                <v-list-item
                  v-for="suggested in suggestedMovies"
                  :key="suggested.id"
                  class="suggested-item"
                >
                  <router-link
                    :to="{
                      name: 'MovieDetail',
                      params: { slug: suggested.slug },
                    }"
                    class="text-decoration-none"
                  >
                    <v-list-item-avatar size="80">
                      <v-img
                        :src="getOptimizedImage(suggested.poster_url)"
                        :lazy-src="getOptimizedImage(suggested.poster_url)"
                      />
                    </v-list-item-avatar>

                    <v-list-item-content>
                      <v-list-item-title
                        class="text-white text-wrap text-body-2"
                      >
                        {{ suggested.name }}
                      </v-list-item-title>
                      <v-list-item-subtitle
                        class="text-grey-lighten-1 text-caption"
                      >
                        {{ suggested.episode_current }} | {{ suggested.lang
                        }}<br />
                        {{ suggested.category[0]?.name }} ‚Ä¢ {{ suggested.year }}
                      </v-list-item-subtitle>
                    </v-list-item-content>
                  </router-link>
                </v-list-item>
              </v-list>
            </v-card-text>
          </v-card>
        </v-col>

        <!-- G·ª£i √Ω m·ªü r·ªông b√™n d∆∞·ªõi ch·ªâ hi·ªán tr√™n desktop -->

        <div class="suggested-movies my-8">
          <h2 class="text-h5 mb-4">üé¨ {{ $t("Phim ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t") }}</h2>
          <v-row>
            <v-col
              v-for="suggested in suggestedMovies"
              :key="suggested._id"
              cols="6"
              sm="4"
              md="2"
            >
              <router-link
                :to="{ name: 'MovieDetail', params: { slug: suggested.slug } }"
                class="text-decoration-none"
              >
                <v-card elevation="2" class="bg-grey-darken-4" hover>
                  <v-img
                    :lazy-src="getOptimizedImage(suggested.poster_url)"
                    :src="getOptimizedImage(suggested.poster_url)"
                    aspect-ratio="16/9"
                    cover
                  ></v-img>
                  <v-card-title class="text-white text-body-2 text-wrap">
                    {{ suggested.name }}
                  </v-card-title>
                  <v-card-subtitle
                    class="text-grey-lighten-1 text-caption px-4 pb-4"
                  >
                    {{ suggested.episode_current }} | {{ suggested.lang }}<br />
                    {{ suggested.category[0]?.name }} ‚Ä¢ {{ suggested.year }}
                  </v-card-subtitle>
                </v-card>
              </router-link>
            </v-col>
          </v-row>
        </div>
      </v-row>

      <!-- dialog share -->
      <v-dialog v-model="shareDialog" max-width="500">
        <v-card class="pa-4" style="background-color: #1e1e1e; color: white">
          <v-card-title class="text-h6 justify-center">Chia s·∫ª</v-card-title>

          <v-row class="justify-center mt-4" dense>
            <v-col cols="3" class="text-center">
              <v-btn
                icon
                size="large"
                @click="shareTo('facebook')"
                class="bg-grey-darken-4"
              >
                <v-icon icon="mdi-facebook" />
              </v-btn>
              <div class="mt-1 text-caption">Facebook</div>
            </v-col>

            <v-col cols="3" class="text-center">
              <v-btn
                icon
                size="large"
                @click="shareTo('youtube')"
                class="bg-grey-darken-4"
              >
                <v-icon icon="mdi-youtube" />
              </v-btn>
              <div class="mt-1 text-caption">YouTube</div>
            </v-col>

            <v-col cols="3" class="text-center">
              <v-btn
                icon
                size="large"
                @click="copyLink"
                class="bg-grey-darken-4"
              >
                <v-icon icon="mdi-link-variant" />
              </v-btn>
              <div class="mt-1 text-caption">Copy link</div>
            </v-col>

            <v-col cols="3" class="text-center">
              <v-btn
                icon
                size="large"
                @click="shareTo('twitter')"
                class="bg-grey-darken-4"
              >
                <v-icon icon="mdi-twitter" />
              </v-btn>
              <div class="mt-1 text-caption">Twitter</div>
            </v-col>
          </v-row>

          <v-card
            class="mt-4 px-3 py-2 d-flex align-center"
            style="background-color: #2a2a2a; border-radius: 8px"
          >
            <span class="text-truncate" style="color: #facc15; max-width: 100%">
              {{ shareUrl }}
            </span>
            <v-spacer />
            <v-btn icon @click="copyLink" size="small">
              <v-icon icon="mdi-content-copy" />
            </v-btn>
          </v-card>

          <v-btn
            icon
            class="position-absolute"
            style="top: 8px; right: 8px"
            @click="shareDialog = false"
          >
            <v-icon icon="mdi-close" />
          </v-btn>
        </v-card>
      </v-dialog>
      <!-- Snackbar -->
      <v-snackbar v-model="mess" :timeout="3000" :color="color">
        {{ Message }}
      </v-snackbar>
    </div>
  </v-container>
</template>

<script>
import {
  MoveInfor,
  MoveInfor1,
  ListMovieByCate,
  Categoris1,
  urlImage,
  urlImage1,
  GetComments,
  AddComment,
} from "@/model/api";
import {  toggleFavorite, isFavorite } from "@/utils/favorite";
import Hls from "hls.js";
export default {
  name: "MovieDetail",
  data() {
    return {
      dialogTrailer: false,
      videoLoaded: false,
      tab: "",
      shareUrl: window.location.href,
      tabserver: null,
      currentEpisodeIndex: 0,
      items: [
        {
          title: "Home",
          disabled: false,
          href: "/home",
        },
        {
          title: this.slug,
          disabled: true,
        },
      ],
      isLoading: true,
      isLoadingData: false,
      Message: "",
      color: "",
      mess: false,
      movie: {
        title: "",
        valueRate: 4.5,
        description: "",
        videoUrl: "",
        actors: [],
        director: [],
        servers: [],
        genre: "",
        pageMovie: [],
        page: 1,
        rating: 5,
        categoris: "",
        trailer_url: "",
        name: "",
        LinkDown: "",
        trailer_id: "",
        idMovie: "",
        thumb_url: "",
        lang: "",
        origin_name: "",
        year: "",
        slug: "",
      },
      isTrailer: false,
      urlImage: urlImage,
      urlImage1: urlImage1,
      suggestedMovies: [],
      comments: [],
      newComment: "",
      shareDialog: false,
      link: "",
      liked: false
    };
  },
  props: ["slug"],
  watch: {
    async slug(newSlug) {
      await this.MoveInfor1(newSlug);
      this.playVideo(this.movie.videoUrl);
      await this.ListMovieByCate();
      //await this.GetComment();
    },
  },
  async mounted() {
    try {
      await this.MoveInfor1(this.slug);
      this.playVideo(this.movie.videoUrl);
      await this.ListMovieByCate();
      //await this.GetComment();
    } catch (err) {
      console.log(err);
    }
  },
  methods: {
    // Call API
    MoveInfor(slug) {
      return new Promise((resolve, reject) => {
        MoveInfor(
          slug,
          (result) => {
            console.log(result)
            if (result.status == true || result.status == "success") {
              this.link = "";
              this.movie.page = result.movie.episode_current;
              this.movie.idMovie = result.movie._id;
              this.movie.title = result.movie.name;
              this.movie.description = result.movie.content;
              this.movie.pageMovie = result.episodes[0].server_data;
              this.movie.director = result.movie.director;
              this.movie.servers = result.episodes;
              this.movie.trailer_url = result.movie.trailer_url;
              this.movie.name = result.movie.name;
              this.movie.thumb_url = result.movie.thumb_url
              this.movie.lang = result.movie.lang
              this.movie.origin_name = result.movie.origin_name
              this.movie.year = result.movie.year
              this.movie.slug = result.movie.slug
              // if (result.data.seoOnPage) {
              //   this.updateMetaTags(result.data.seoOnPage)
              // }
              if (this.movie.trailer_url != "") {
                this.movie.trailer_id = this.movie.trailer_url.split("?v=")[1];
              }

              if (
                result.movie.status == "trailer" ||
                result.episodes[0].server_data[0].link_embed == ""
              ) {
                this.movie.videoUrl = result.movie.trailer_url;
                // this.movie.title = result.movie.name;
                this.isTrailer = true;
              } else {
                if (
                  this.movie.page == "Full" ||
                  this.movie.page.toUpperCase().includes("HO√ÄN T·∫§T") ||
                  this.movie.page.includes("/")
                ) {
                  this.movie.videoUrl =
                    result.episodes[0].server_data[0].link_embed;
                  // this.movie.title = result.movie.name;
                  this.isTrailer = false;
                } else {
                  var tap = this.movie.page.split("T·∫≠p ")[1].trim();
                  const data = result.episodes[0].server_data.find(
                    (ep) => ep.slug === tap || ep.slug.includes(tap)
                  );
                  this.currentEpisodeIndex = parseInt(tap,10) -1;
                  if (data) {
                    this.movie.videoUrl = data.link_embed;
                    this.movie.LinkDown = data.link_m3u8;
                    // this.movie.title = data.filename;
                    this.isTrailer = false;
                  } else {
                    const data = result.episodes[1].server_data.find(
                      (ep) => ep.slug === tap || ep.slug.includes(tap)
                    );
                    if (data) {
                      this.movie.videoUrl = data.link_embed;
                      this.movie.LinkDown = data.link_m3u8;
                      // this.movie.title = data.filename;
                      this.isTrailer = false;
                    }
                  }
                  // this.movie.videoUrl = result.episodes[0].server_data[tap-1].link_embed
                  // this.isTrailer = false;
                }
              }
              this.movie.actors = result.movie.actor;
              for (var i = 0; i < result.movie.country.length; i++) {
                this.movie.genre = result.movie.country[i];
              }
              this.movie.categoris = result.movie.category[0].slug;
              this.isLoading = false;
              // this.GetComment()
              this.liked = isFavorite(this.movie.idMovie);
              resolve(true);
            } else {
              reject("error");
            }
          },
          (err) => {
            console.log(err);
            this.loading = false;
            this.isLoadingData = true;
            reject(err);
          }
        );
      });
    },
    MoveInfor1(slug) {
      return new Promise((resolve, reject) => {
        MoveInfor1(
          slug,
          (result) => {
            console.log(result)
            if (result.status == true || result.status == "success") {
              this.link = "link";
              this.movie.page = result.movie.episode_current;
              this.movie.idMovie = result.movie._id;
              this.movie.title = result.movie.name;
              this.movie.description = result.movie.content;
              this.movie.pageMovie = result.episodes[0].server_data;
              this.movie.director = result.movie.director;
              this.movie.servers = result.episodes;
              this.movie.trailer_url = result.movie.trailer_url;
              this.movie.name = result.movie.name;
              this.movie.thumb_url = result.movie.thumb_url;
              this.movie.lang = result.movie.lang;
              this.movie.origin_name = result.movie.origin_name
              this.movie.year = result.movie.year
              this.movie.slug = result.movie.slug

              // if (result.data.seoOnPage) {
              //   this.updateMetaTags(result.data.seoOnPage)
              // }

              if (this.movie.trailer_url != "") {
                this.movie.trailer_id = this.movie.trailer_url.split("?v=")[1];
              }
              if (
                result.movie.status == "trailer" ||
                result.episodes[0].server_data[0].link_embed == ""
              ) {
                this.movie.videoUrl = result.movie.trailer_url;
                this.movie.title = result.movie.name;
                this.isTrailer = true;
              } else {
                if (
                  this.movie.page == "Full" ||
                  this.movie.page.toUpperCase().includes("HO√ÄN T·∫§T") ||
                  this.movie.page.includes("/")
                ) {
                  this.movie.videoUrl =
                    result.episodes[0].server_data[0].link_embed;
                  this.movie.title = result.movie.name;
                  this.isTrailer = false;
                } else {
                  var tap = this.movie.page.split("T·∫≠p ")[1].trim();
                  const data = result.episodes[0].server_data.find(
                    (ep) => ep.slug === tap || ep.slug.includes(tap)
                  );
                  this.currentEpisodeIndex = parseInt(tap,10)-1;

                  if (data) {
                    this.movie.videoUrl = data.link_embed;
                    this.movie.title = data.filename;
                    this.isTrailer = false;
                  } else {
                    const data = result.episodes[1].server_data.find(
                      (ep) => ep.slug === tap || ep.slug.includes(tap)
                    );
                    if (data) {
                      this.movie.videoUrl = data.link_embed;
                      this.movie.title = data.filename;
                      this.isTrailer = false;
                    }
                  }
                  // this.movie.videoUrl = result.episodes[0].server_data[tap-1].link_embed
                  // this.isTrailer = false;
                }
              }
              this.movie.actors = result.movie.actor;
              for (var i = 0; i < result.movie.country.length; i++) {
                this.movie.genre = result.movie.country[i];
              }
              this.movie.categoris = result.movie.category[0].slug;
              this.isLoading = false;
              // this.GetComment()
              this.liked = isFavorite(this.movie._id);
              resolve(true);
            } else {
              this.MoveInfor(slug).then(resolve).catch(reject);
              // reject("error");
            }
          },
          (err) => {
            console.log(err);
            this.MoveInfor(slug).then(resolve).catch(reject);
            //reject(err);
          }
        );
      });
    },


    playVideo(url) {
      const video = this.$refs.videoPlayer;
      console.log(video)
      console.log(url)
      if (!video) return;

      // N·∫øu l√† file .m3u8 ‚Üí d√πng HLS
      if (Hls.isSupported() && url.endsWith(".m3u8")) {
        const hls = new Hls({ maxBufferLength: 5 });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play();
        });
      } else {
        // N·∫øu l√† mp4 ho·∫∑c youtube th√¨ d√πng th·∫ª video th√¥ng th∆∞·ªùng
        video.src = url;
        video.play();
      }
    },
    DownloadVideo(linkdown) {
      window.open(linkdown);
    },
    handleFavorite(){
      let aa = toggleFavorite(this.movie);
      console.log(aa)
      this.liked = !this.liked;
    },

    getOptimizedImage(imagePath) {
      if (this.link == "") {
        return `${this.urlImage + encodeURIComponent(imagePath)}&w=384&q=100`;
      } else {
        return `${
          this.urlImage1 +
          "https://phimimg.com/" +
          encodeURIComponent(imagePath)
        }`;
      }
    },
    // Chu·∫£n SEO
    updateMetaTags(seo) {
      document.title = seo.titleHead || "Phim hay";

      const removeOldMeta = (key, attr = "name") => {
        const old = document.querySelectorAll(`meta[${attr}="${key}"]`);
        old.forEach((tag) => tag.remove());
      };

      const setMeta = (key, content, attr = "name") => {
        if (!content) return;
        const meta = document.createElement("meta");
        meta.setAttribute(attr, key);
        meta.setAttribute("content", content);
        document.head.appendChild(meta);
      };

      // X√≥a c≈©
      removeOldMeta("description");
      removeOldMeta("og:title", "property");
      removeOldMeta("og:description", "property");
      removeOldMeta("og:type", "property");
      removeOldMeta("og:image", "property");

      // Th√™m m·ªõi
      setMeta("description", seo.descriptionHead);
      setMeta("og:title", seo.titleHead, "property");
      setMeta("og:description", seo.descriptionHead, "property");
      setMeta("og:type", seo.og_type || "website", "property");

      if (Array.isArray(seo.og_image)) {
        seo.og_image.forEach((img) => {
          setMeta("og:image", img, "property");
        });
      }
    },
    ListMovieByCate() {
      return new Promise((resolve, reject) => {
        if (this.link == "") {
          ListMovieByCate(
            this.movie.categoris,

            (data) => {
              if (data.status == "success") {
                this.suggestedMovies = data.data.items;
                this.isLoading = false;
                resolve(true);
              } else {
                reject("error");
              }
            },
            (err) => {
              console.log(err);
              reject(err);
            }
          );
        } else {
          Categoris1(
            this.movie.categoris,

            (data) => {
              if (data.status == true) {
                this.suggestedMovies = data.data.items;
                this.isLoading = false;
                resolve(true);
              } else {
                reject("error");
              }
            },
            (err) => {
              console.log(err);
              reject(err);
            }
          );
        }
      });
    },
    shareMovie() {
      this.shareDialog = true;
    },

    shareTo(platform) {
      // const url = encodeURIComponent(shareUrl.value);
      // const text = encodeURIComponent("Xem phim n√†y n√®!");
      let shareLink = "";

      switch (platform) {
        case "facebook":
          shareLink = `https://www.facebook.com/sharer/sharer.php`;
          break;
        case "youtube":
          shareLink = `https://www.youtube.com/`;
          break;
        case "twitter":
          shareLink = `https://twitter.com`;
          break;
      }
      // const shareUrl = window.location.href;

      window.open(shareLink, "_blank");
    },
    ResponseError() {
      this.Message = this.$t("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi Admin ƒë·ªÉ x·ª≠ l√Ω");
      this.color = "error";
      this.mess = true;
    },
    copyLink() {
      const shareUrl = window.location.href;
      navigator.clipboard.writeText(shareUrl).then(() => {
        alert(this.$t("ƒê√£ sao ch√©p li√™n k·∫øt!"));
      });
    },
    addComment() {
      var account = localStorage.getItem("name");
      var data = {
        movieId: this.movie.idMovie,
        episode: this.movie.page,
        userId: this.$store.state.empInfor.id,
        username: account,
        content: this.newComment,
      };
      if (account == null || account == "") {
        this.$router.push("/login");
      }
      if (this.newComment.trim()) {
        AddComment(
          data,
          (dat) => {
            if (dat.status == 201) {
              this.Message = dat.data.message;
              this.color = "success";
              this.mess = true;
              this.GetComment();
            }
          },
          (err) => {
            this.Message = err.response.data.message;
            this.color = "error";
            this.mess = true;
          }
        );
        this.newComment = "";
      }
    },
    GetComment() {
      return new Promise((resolve, reject) => {
        if (!this.movie.idMovie) reject("error");
        GetComments(
          { movieId: this.movie.idMovie, episode: this.movie.page },
          (res) => {
            if (Array.isArray(res)) {
              this.comments = res.map((c) => ({
                username: c.username,
                content: c.content,
                createdAt: c.createdAt,
              }));
              resolve(true);
            } else {
              reject("error");
            }
          },
          (err) => {
            console.error("L·ªói l·∫•y b√¨nh lu·∫≠n:", err);
            reject(err);
          }
        );
      });
    },

    scrollLeft() {
      const container = this.$refs.slideWrapper;
      if (container) {
        container.scrollBy({ left: -220, behavior: "smooth" });
      }
    },
    scrollRight() {
      const container = this.$refs.slideWrapper;
      if (container) {
        container.scrollBy({ left: 220, behavior: "smooth" });
      }
    },
    getTrailer() {
      this.movie.videoUrl = this.movie.trailer_url;
      this.isTrailer = true;
    },
    playEpisode(episode) {
      try{
        this.isLoading = true;
        if(episode.filename != undefined || episode.filename != null || episode.filename != ''){
          this.movie.title = episode.filename;

        }
        this.movie.videoUrl = episode.link_embed;
        this.movie.LinkDown = episode.link_m3u8;
        this.currentEpisodeIndex = this.movie.pageMovie.findIndex(
          (ep) => ep.name === episode.name
        );
        this.movie.page = episode.name;
        this.GetComment();
        this.isLoading = false;
      }
      catch{
        this.isLoading = false;
        
      }
      
    },
    switchServer(server) {
      this.isLoading = true;
      
      this.movie.pageMovie = server.server_data;
      if (
        this.movie.page == "Full" ||
        // this.movie.page.toUpperCase().includes("HO√ÄN T·∫§T") ||
        this.movie.page.includes("/")
      ) {
        this.movie.videoUrl = server.server_data[0].link_embed;
        this.movie.LinkDown = server.server_data[0].link_m3u8;
        this.isTrailer = false;
      } else {
        var tap = this.movie.page.split("T·∫≠p ")[1].trim();
        const data = server.server_data.includes(tap);
        if (data) {
          this.movie.videoUrl = data.link_embed;
          this.movie.LinkDown = data.link_m3u8;
          this.isTrailer = false;
        }
      }
      

      this.GetComment();
      setTimeout(() => {
        this.isLoading = false;

      }, 1000);
    },
    nextEpisode() {
  if (this.currentEpisodeIndex < this.movie.pageMovie.length - 1) {
    this.currentEpisodeIndex++;
    const nextEp = this.movie.pageMovie[this.currentEpisodeIndex];
    this.playEpisode(nextEp);
  }
},
prevEpisode() {
  if (this.currentEpisodeIndex > 0) {
    this.currentEpisodeIndex--;
    const prevEp = this.movie.pageMovie[this.currentEpisodeIndex];
    this.playEpisode(prevEp);
  }
},
    generateEmbedHtml(url) {
      if (this.isTrailer) {
        const youtubeMatch = this.movie.trailer_url.split("?v=");
        // const youtubeMatch = url.match(
        //   /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^\s&]+)/
        // );
        if (youtubeMatch.length > 0) {
          const videoId = youtubeMatch[1];

          return `
            <iframe width="100%" height="100%"
              src="https://www.youtube.com/embed/${videoId}?autoplay=1"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: manipulation;"
              >
            </iframe>
          `;
        } else {
          // N·∫øu kh√¥ng ph·∫£i YouTube th√¨ gi·∫£ s·ª≠ l√† .mp4 v√† d√πng th·∫ª video
          return `
            <video width="100%" height="100%" controls preload="none" style="touch-action: manipulation;">
              <source src="${url}" type="video/mp4">
              Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
            </video>
          `;
        }
        //return `<video width="100%" height="600" controls><source src="${url}" type="video/mp4">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.</video> `;
      } else {
        return `<div style="position: relative; width: 100%; padding-bottom: 56.25%; ">
      <iframe
        src="${url}"
        frameborder="0"
        class="w-full h-full"
        webkit-playsinline
        loading="lazy"
        allowfullscreen
        sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
        allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: manipulation;"
      ></iframe>
    </div>`;
      }
    },
  },
  computed: {
    thumbnailUrl() {
      const match = this.movie.videoUrl.match(
        /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^\s&]+)/
      );
      return match
        ? `https://img.youtube.com/vi/${match[1]}/maxresdefault.jpg`
        : "/placeholder.jpg"; // fallback ·∫£nh tƒ©nh n·∫øu kh√¥ng ph·∫£i YouTube
    },

    embedHtml() {
      const url = this.movie.videoUrl;
      if (this.isTrailer) {
        const youtubeMatch = url.match(
          /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^\s&]+)/
        );
        if (youtubeMatch) {
          const videoId = youtubeMatch[1];
          return `
            <iframe width="100%" height="600"
              src="https://www.youtube.com/embed/${videoId}"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: manipulation;"
              
              >
            </iframe>
          `;
        } else {
          return `
            <video width="100%" height="600" controls preload="none" style="touch-action: manipulation;">
              <source src="${url}" type="video/mp4">
              Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
            </video>
          `;
        }
      } else {
        return `
          <div style="position: relative; width: 100%; padding-bottom: 56.25%;">
            <iframe
              src="${url}"
              frameborder="0"
              class="w-full h-full"
              webkit-playsinline
              loading="lazy"
              allowfullscreen
              allow=" fullscreen"
              sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: manipulation;"
            ></iframe>
          </div>
        `;
      }
    },
  },
};
</script>

<style scoped>
.video-wrapper {
  width: 100%;
  aspect-ratio: 16 / 9;
  background: black;
  position: relative;
  overflow: hidden;
}

.video-wrapper iframe,
.video-wrapper video {
  width: 100%;
  height: 100%;
}
.suggested-item {
  cursor: pointer;
  transition: background-color 0.2s ease;
  border-radius: 8px;
}

.text-wrap {
  white-space: normal !important;
  overflow-wrap: break-word;
}

.suggested-item:hover {
  background-color: #2e2e2e;
}

.movie-detail {
  padding: 12px 0;
}
a {
  color: #fff;
}
.custom-tabs .v-tab {
  color: white;
  background-color: transparent;
  border-radius: 8px;
  transition: all 0.3s;
}
.custom-tabs .v-tab.active-tab {
  color: #000;
  background-color: #f8b230;
  border-radius: 5px;
  font-weight: bold;
}

.movie-info p {
  margin-bottom: 8px;
}

.scroll-container {
  scroll-behavior: smooth;
  gap: 16px;
}

.movie-card-link {
  text-decoration: none;
  color: inherit;
  flex-shrink: 0;
}

.text-truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.position-absolute {
  position: absolute;
}

.top-0 {
  top: 0;
}

.left-0 {
  left: 0;
}
.suggested-slide-wrapper {
  overflow-x: auto;
  overflow-y: hidden;
  padding-bottom: 10px;
  scroll-behavior: smooth;
}

.suggested-slide {
  display: flex;
  gap: 16px;
  transition: transform 0.3s ease-in-out;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}

.movie-card {
  flex: 0 0 auto;
  width: 200px;
  background-color: #2e2e2e;
  border-radius: 12px;
  overflow: hidden;
  scroll-snap-align: start;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.movie-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
}

.card-inner {
  position: relative;
}

.card-image-wrapper {
  position: relative;
  overflow: hidden;
  height: 300px;
}

.card-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.4s ease;
}

.movie-card:hover .card-image {
  transform: scale(1.05);
}

.card-hover-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  text-align: center;
  padding: 8px;
  transform: translateY(100%);
  transition: transform 0.3s ease;
}

.movie-card:hover .card-hover-overlay {
  transform: translateY(0);
}

.card-title {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-info {
  padding: 12px;
  color: #ccc;
}

.episode-chip {
  display: inline-block;
  background-color: #ffd600;
  color: black;
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 500;
  margin-bottom: 6px;
}

.origin {
  font-weight: bold;
  color: #fff;
}

.meta {
  font-size: 0.8rem;
  color: #aaa;
}

/* N√∫t ƒëi·ªÅu h∆∞·ªõng tr√°i ph·∫£i */
.nav-btn {
  background-color: rgba(0, 0, 0, 0.6);
  border: none;
  color: white;
  font-size: 24px;
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 50%;
  user-select: none;
  transition: background-color 0.3s ease;
  z-index: 10;
  flex-shrink: 0;
}

.nav-btn:hover {
  background-color: rgba(0, 0, 0, 0.9);
}

.nav-btn.left {
  margin-right: 8px;
}

.nav-btn.right {
  margin-left: 8px;
}

.trailer-thumb {
  width: 222px;
  height: 125px;
  position: relative;
  overflow: hidden;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45);
  transition: transform 0.25s ease;
}

/* ·∫¢nh */
.trailer-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform 0.35s ease;
}

/* overlay (m·∫∑c ƒë·ªãnh trong su·ªët) */
.trailer-overlay {
  position: absolute;
  inset: 0; /* top:0;right:0;bottom:0;left:0; */
  background: rgba(0, 0, 0, 0);
  transition: background 0.25s ease;
  pointer-events: none; /* ƒë·ªÉ click qua overlay */
}

/* n√∫t play (·∫©n m·∫∑c ƒë·ªãnh) */
.trailer-play {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  opacity: 0;
  transition: opacity 0.18s ease, transform 0.18s ease;
  pointer-events: none; /* cho ph√©p click container */
  filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.6));
}

/* khi hover -> l√†m n·ªïi ·∫£nh, hi·ªán overlay + play */
.trailer-thumb:hover img {
  transform: scale(1.03);
}

.trailer-thumb:hover .trailer-overlay {
  background: rgba(0, 0, 0, 0.45);
  border: 1px solid yellow;
}

.trailer-thumb:hover .trailer-play {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}
.episode-list {
  display: flex;
  flex-wrap: wrap;
}
.episode-col {
  flex: 0 0 20% !important;  
  max-width: 20% !important; 
  padding: 4px;
}
</style>
